FROM node:20-alpine
WORKDIR /app

# Install dependencies (use npm install instead of npm ci to avoid workspace/lockfile incompatibilities
# and install Alpine build deps so native modules can compile)
COPY package*.json ./
COPY package-lock.json ./
RUN apk add --no-cache --virtual .build-deps python3 make g++ gcc libc-dev linux-headers git \
	&& npm install \
	&& apk del .build-deps || true

# Copy source
COPY . .

ENV PORT=5000
EXPOSE 5000

# Use npx next dev with explicit port to avoid Windows 'set' in package.json dev script
CMD ["sh", "-c", "PORT=5000 npx next dev -p 5000"]
